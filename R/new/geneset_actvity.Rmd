# Title: Identification of Gene sets

## Reference:

[PangloaDB](https://panglaodb.se/)
[AUCell: Identifying cells with active gene sets](https://bioconductor.org/packages/release/bioc/vignettes/AUCell/inst/doc/AUCell.html)
[Tabular Muris lung h5ad data](https://figshare.com/articles/dataset/Tabula_Muris_Senis_Data_Objects/12654728?file=23873012)

## Goal

Which of your cells are actively expressing a gene set? 
AUCell allows to label cells in a Seraut object which are 
enriched for user provided genes. This method is useful 
if you want to find which cells express a certain set of genes. 
These can be putative identity markers, response genes of some 
biological pathway, or any set of genes you are interested in. 
AUCell is a widely used and cited package.

PangloaDB, is an extremely useful database for cell 
identity markers in human and mouse single-cell data.


## Load packages

```{r}

if (!require("pacman", quietly = TRUE))
  install.packages("pacman")

remotes::install_github("mojaveazure/seurat-disk", force = TRUE)
        
p_load(pacman, tidyverse, Seurat, AUCell, SeuratDisk)


```

## Load data

```{r}

load("../../data/droplet_Lung_seurat_tiss.Robj")
tiss <- UpdateSeuratObject(object = tiss)

```


```{r}

DimPlot(tiss, label = TRUE, group.by = "cell_ontology_class")

```


## Select markers for endothelial cells

Endothelial cells would be identified, then gene symbols
would be converted to follow conventions

```{r}

markers <- read.csv("../../data/PanglaoDB_markers_27_Mar_2020.tsv", sep = "\t")
markers <- markers[markers$cell.type == "Endothelial cells" & markers$species != "Hs",]
markers$official.gene.symbol <- str_to_title(markers$official.gene.symbol)


```

## Identification of Enriched Genes


```{r}

counts <- GetAssayData(tiss, slot = "counts")
cell_rankings <- AUCell_buildRankings(counts)

```



```{r}

genes <- markers$official.gene.symbol
cell_auc <- AUCell_calcAUC(genes, cell_rankings)

```

```{r}

cell_assignments <- AUCell_exploreThresholds(cell_auc, plotHist = TRUE, assign = TRUE)

```

We would adjust our threshold here to 0.15, because the out sample size is
reflective of Lung Endothelial cells, hence giving us a much more representative
population cell.

NB: AUCell does not work on every dataset, and ideally you want a bimodal distribution
with one population not being too representative.

```{r}

new_cells <- names(which(getAUC(cell_auc)["geneSet", ] > 0.15))
tiss$is_ec <- ifelse(colnames(tiss) %in% new_cells, "EC", "non_EC")


```

```{r}

DimPlot(tiss, group.by = "is_ec", label = TRUE)
DimPlot(tiss, label = TRUE, group.by = "cell_ontology_class")

```

## Unload packages and clear environment

```{r}
p_unload(pacman, tidyverse, Seurat, AUCell, SeuratDisk)
rm(list = ls())
```







